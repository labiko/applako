<ion-header>
  <ion-toolbar color="primary">
    <ion-button 
      slot="start" 
      fill="clear" 
      (click)="goBack()"
      color="light">
      <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
    </ion-button>
    <ion-title>
      <ion-icon name="business-outline"></ion-icon>
      Gestion des Entreprises
    </ion-title>
    <ion-button 
      slot="end" 
      fill="clear" 
      (click)="onRefresh()"
      color="light">
      <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="page-container">
    
    <!-- Statistiques -->
    <ion-card class="stats-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="stats-chart-outline"></ion-icon>
          Statistiques Entreprises
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6" size-md="3">
              <div class="stat-item">
                <div class="stat-number">{{ stats.total_entreprises }}</div>
                <div class="stat-label">Total</div>
              </div>
            </ion-col>
            <ion-col size="6" size-md="3">
              <div class="stat-item">
                <div class="stat-number success">{{ stats.entreprises_actives }}</div>
                <div class="stat-label">Actives</div>
              </div>
            </ion-col>
            <ion-col size="6" size-md="3">
              <div class="stat-item">
                <div class="stat-number warning">{{ stats.entreprises_inactives }}</div>
                <div class="stat-label">Inactives</div>
              </div>
            </ion-col>
            <ion-col size="6" size-md="3">
              <div class="stat-item">
                <div class="stat-number primary">{{ stats.nouveaux_ce_mois }}</div>
                <div class="stat-label">Ce mois</div>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Actions rapides -->
    <ion-card class="actions-card">
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="4">
              <ion-button 
                expand="block" 
                fill="solid"
                color="primary"
                (click)="onCreateEntreprise()">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Nouvelle Entreprise
              </ion-button>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-button 
                expand="block" 
                fill="outline"
                color="warning"
                (click)="onResetPassword()">
                <ion-icon name="key-outline" slot="start"></ion-icon>
                Réinitialiser Mot de Passe
              </ion-button>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-button 
                expand="block" 
                fill="outline"
                color="medium"
                (click)="onExportData()">
                <ion-icon name="stats-chart-outline" slot="start"></ion-icon>
                Export Données
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Recherche -->
    <ion-card class="search-card">
      <ion-card-content>
        <ion-searchbar
          [(ngModel)]="searchQuery"
          placeholder="Rechercher entreprise..."
          (ionInput)="onSearch()"
          debounce="500">
        </ion-searchbar>
      </ion-card-content>
    </ion-card>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Chargement des entreprises...</p>
    </div>

    <!-- Liste des entreprises -->
    <ion-card *ngIf="!isLoading" class="entreprises-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="business-outline"></ion-icon>
          Entreprises ({{ filteredEntreprises.length }})
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        
        <!-- Message si aucune entreprise -->
        <div *ngIf="filteredEntreprises.length === 0" class="empty-state">
          <ion-icon name="business-outline" size="large"></ion-icon>
          <h3>Aucune entreprise trouvée</h3>
          <p>Créez votre première entreprise pour commencer.</p>
          <ion-button fill="outline" (click)="onCreateEntreprise()">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Créer une entreprise
          </ion-button>
        </div>

        <!-- Liste des entreprises -->
        <ion-list *ngIf="filteredEntreprises.length > 0">
          <ion-item 
            *ngFor="let entreprise of filteredEntreprises; trackBy: trackByEntreprise"
            class="entreprise-item">
            
            <div class="entreprise-content">
              <!-- Header avec nom et statut -->
              <div class="entreprise-header">
                <div class="entreprise-info">
                  <h3>{{ entreprise.nom }}</h3>
                  <p class="entreprise-email">{{ entreprise.email }}</p>
                </div>
                <div class="status-section">
                  <ion-badge 
                    [color]="entreprise.actif ? 'success' : 'danger'"
                    class="status-badge">
                    {{ entreprise.actif ? 'Active' : 'Inactive' }}
                  </ion-badge>
                  <ion-badge 
                    *ngIf="!entreprise.password_hash"
                    color="warning"
                    class="password-badge">
                    Pas de mot de passe
                  </ion-badge>
                </div>
              </div>

              <!-- Détails -->
              <div class="entreprise-details">
                <div class="detail-row" *ngIf="entreprise.telephone">
                  <ion-icon name="call-outline"></ion-icon>
                  <span>{{ entreprise.telephone }}</span>
                </div>
                <div class="detail-row" *ngIf="entreprise.adresse">
                  <ion-icon name="location-outline"></ion-icon>
                  <span>{{ entreprise.adresse }}</span>
                </div>
                <div class="detail-row" *ngIf="entreprise.siret">
                  <ion-icon name="card-outline"></ion-icon>
                  <span>SIRET: {{ entreprise.siret }}</span>
                </div>
                <div class="detail-row" *ngIf="entreprise.responsable">
                  <ion-icon name="person-outline"></ion-icon>
                  <span>Responsable: {{ entreprise.responsable }}</span>
                </div>
                <div class="detail-row">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>Créée le {{ formatDate(entreprise.created_at) }}</span>
                </div>
              </div>

              <!-- Actions -->
              <div class="entreprise-actions">
                <ion-button 
                  size="small" 
                  fill="clear" 
                  (click)="onViewDetails(entreprise)">
                  <ion-icon name="eye-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <ion-button 
                  size="small" 
                  fill="clear" 
                  color="primary"
                  (click)="onViewConducteurs(entreprise)">
                  <ion-icon name="people-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <ion-button 
                  size="small" 
                  fill="clear" 
                  color="success"
                  (click)="onAddConducteur(entreprise)"
                  title="Ajouter un conducteur">
                  <ion-icon name="add-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <ion-button 
                  size="small" 
                  fill="clear" 
                  (click)="onEditEntreprise(entreprise)">
                  <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <ion-button 
                  size="small" 
                  fill="clear" 
                  color="warning"
                  (click)="onResetPasswordSpecific(entreprise)">
                  <ion-icon name="key-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <ion-button 
                  size="small" 
                  fill="clear" 
                  color="secondary"
                  (click)="onConfigureLengoPay(entreprise)"
                  title="Configuration LengoPay">
                  <ion-icon name="card-outline" slot="icon-only"></ion-icon>
                </ion-button>

                <!-- Boutons blocage/déblocage -->
                <ion-button 
                  *ngIf="entreprise.actif"
                  size="small" 
                  fill="clear" 
                  color="danger"
                  (click)="onDesactiverEntreprise(entreprise)">
                  <ion-icon name="lock-closed-outline" slot="icon-only"></ion-icon>
                </ion-button>

                <ion-button 
                  *ngIf="!entreprise.actif"
                  size="small" 
                  fill="clear" 
                  color="success"
                  (click)="onReactiverEntreprise(entreprise)">
                  <ion-icon name="lock-open-outline" slot="icon-only"></ion-icon>
                </ion-button>
                
                <ion-toggle
                  [checked]="entreprise.actif"
                  (ionChange)="onToggleStatus(entreprise, $event)"
                  color="success">
                </ion-toggle>
              </div>
            </div>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

  </div>

  <!-- Modal Création/Modification Entreprise -->
  <ion-modal [isOpen]="isCreateModalOpen" (didDismiss)="closeCreateModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>{{ editingEntreprise ? 'Modifier' : 'Créer' }} Entreprise</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeCreateModal()">
              <ion-icon name="close-circle-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        
        <ion-item>
          <ion-label position="stacked">Nom de l'entreprise *</ion-label>
          <ion-input
            [(ngModel)]="formData.nom"
            placeholder="Ex: Taxi Express Conakry">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Email *</ion-label>
          <ion-input
            [(ngModel)]="formData.email"
            type="email"
            placeholder="contact@entreprise.com">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Téléphone *</ion-label>
          <ion-input
            [(ngModel)]="formData.telephone"
            type="tel"
            placeholder="+224 123 456 789">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Adresse *</ion-label>
          <ion-textarea
            [(ngModel)]="formData.adresse"
            placeholder="Adresse complète de l'entreprise"
            rows="3">
          </ion-textarea>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">SIRET (optionnel)</ion-label>
          <ion-input
            [(ngModel)]="formData.siret"
            placeholder="12345678901234">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Responsable (optionnel)</ion-label>
          <ion-input
            [(ngModel)]="formData.responsable"
            placeholder="Nom du responsable">
          </ion-input>
        </ion-item>

        <div class="modal-actions">
          <ion-button 
            expand="block" 
            (click)="onSaveEntreprise()"
            [disabled]="!isFormValid()">
            {{ editingEntreprise ? 'Modifier' : 'Créer' }} Entreprise
          </ion-button>
          <ion-button 
            expand="block" 
            fill="outline" 
            (click)="closeCreateModal()">
            Annuler
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal Liste Conducteurs -->
  <ion-modal [isOpen]="isConducteursModalOpen" (didDismiss)="closeConducteursModal()" class="conducteurs-modal">
    <ng-template>
      <ion-header class="conducteurs-modal-header">
        <ion-toolbar color="primary">
          <ion-title>
            <ion-icon name="people-outline"></ion-icon>
            Conducteurs - {{ selectedEntreprise?.nom }}
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeConducteursModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        
        <!-- Stats Conducteurs -->
        <ion-card class="conducteurs-stats-card" *ngIf="conducteursList.length > 0">
          <ion-card-content>
            <ion-grid>
              <ion-row>
                <ion-col size="4">
                  <div class="stat-mini">
                    <div class="stat-value">{{ conducteursList.length }}</div>
                    <div class="stat-label">Total</div>
                  </div>
                </ion-col>
                <ion-col size="4">
                  <div class="stat-mini">
                    <div class="stat-value success">{{ conducteursActifs }}</div>
                    <div class="stat-label">Actifs</div>
                  </div>
                </ion-col>
                <ion-col size="4">
                  <div class="stat-mini">
                    <div class="stat-value warning">{{ conducteursInactifs }}</div>
                    <div class="stat-label">Inactifs</div>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>

        <!-- Loading -->
        <div *ngIf="isLoadingConducteurs" class="loading-container">
          <ion-spinner></ion-spinner>
          <p>Chargement des conducteurs...</p>
        </div>

        <!-- Liste vide -->
        <div *ngIf="!isLoadingConducteurs && conducteursList.length === 0" class="empty-state">
          <ion-icon name="people-outline" size="large"></ion-icon>
          <h3>Aucun conducteur</h3>
          <p>Cette entreprise n'a pas encore de conducteurs.</p>
        </div>

        <!-- Liste des conducteurs avec collapse -->
        <div *ngIf="!isLoadingConducteurs && conducteursList.length > 0">
          <div *ngFor="let conducteur of conducteursList" class="conducteur-item">
            <!-- Header du conducteur (clickable) -->
            <div class="conducteur-header" 
                 [class.expanded]="isExpanded(conducteur.id)"
                 (click)="toggleConducteur(conducteur)">
              <div class="conducteur-main">
                <div class="conducteur-info">
                  <ion-avatar>
                    <div class="avatar-placeholder">{{ getInitials(conducteur) }}</div>
                  </ion-avatar>
                  <div class="info-text">
                    <h3>{{ conducteur.prenom }} {{ conducteur.nom }}</h3>
                    <div class="info-line">
                      <ion-icon name="call-outline"></ion-icon>
                      {{ conducteur.telephone }}
                    </div>
                    <div class="info-line">
                      <ion-icon name="car-outline"></ion-icon>
                      {{ getVehicleTypeLabel(conducteur.vehicle_type) }}
                      <span *ngIf="conducteur.vehicle_marque"> - {{ conducteur.vehicle_marque }}</span>
                    </div>
                    <div class="info-line">
                      <ion-icon name="star"></ion-icon>
                      {{ conducteur.note_moyenne || 5 }}/5 - {{ getReservationsCount(conducteur.id) }} courses
                    </div>
                  </div>
                </div>
                <div class="conducteur-actions">
                  <div class="status-badges">
                    <ion-badge [color]="conducteur.actif ? 'success' : 'danger'">
                      {{ getMotifBlocage(conducteur) }}
                    </ion-badge>
                    <ion-badge [color]="!conducteur.hors_ligne ? 'primary' : 'medium'" *ngIf="conducteur.actif">
                      {{ !conducteur.hors_ligne ? 'En ligne' : 'Hors ligne' }}
                    </ion-badge>
                  </div>

                  <!-- Boutons d'action conducteur -->
                  <div class="conducteur-action-buttons">
                    <ion-button 
                      *ngIf="conducteur.actif"
                      size="small" 
                      fill="clear" 
                      color="danger"
                      (click)="onBloquerConducteur(conducteur); $event.stopPropagation()">
                      <ion-icon name="ban-outline" slot="icon-only"></ion-icon>
                    </ion-button>

                    <ion-button 
                      *ngIf="canDebloquerConducteur(conducteur)"
                      size="small" 
                      fill="clear" 
                      color="success"
                      (click)="onDebloquerConducteur(conducteur); $event.stopPropagation()">
                      <ion-icon name="shield-outline" slot="icon-only"></ion-icon>
                    </ion-button>

                    <ion-button 
                      *ngIf="conducteur.actif"
                      size="small" 
                      fill="clear" 
                      color="danger"
                      (click)="onSupprimerConducteur(conducteur); $event.stopPropagation()"
                      title="Supprimer le conducteur">
                      <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>

                  <ion-icon name="chevron-down-outline" 
                           class="expand-icon" 
                           [class.rotated]="isExpanded(conducteur.id)"></ion-icon>
                </div>
              </div>
            </div>
            
            <!-- Section réservations (collapse) -->
            <div class="conducteur-reservations" [class.expanded]="isExpanded(conducteur.id)">
              <div class="reservations-content">
                <div class="reservations-header">
                  <h4>Réservations récentes</h4>
                  <span class="reservation-count">
                    {{ getReservationsCount(conducteur.id) }} réservation(s)
                  </span>
                </div>
                
                <!-- Loading réservations -->
                <div *ngIf="loadingReservations.has(conducteur.id)" class="ion-text-center ion-padding">
                  <ion-spinner name="crescent"></ion-spinner>
                </div>
                
                <!-- Liste des réservations -->
                <div *ngIf="!loadingReservations.has(conducteur.id)">
                  <div *ngFor="let reservation of getReservations(conducteur.id)" class="reservation-item-entreprise">
                    <!-- Header avec destination et statut moderne -->
                    <div class="reservation-header-entreprise">
                      <div class="header-top">
                        <h4 class="destination-title">{{ reservation.destination_nom || 'Destination non définie' }}</h4>
                        <div class="status-section">
                          <span class="status-badge-primary" [ngClass]="'status-' + reservation.statut">
                            {{ getStatusLabel(reservation.statut) }}
                          </span>
                          <span class="price-badge">
                            <ion-icon name="cash"></ion-icon>
                            {{ formatCurrency(reservation.prix_total) }}
                          </span>
                        </div>
                      </div>
                      <div class="header-bottom">
                        <div class="reservation-id">
                          <ion-icon name="id-card-outline"></ion-icon>
                          <span class="id-text">ID: {{ reservation.id }}</span>
                        </div>
                        <div class="date-info">
                          <ion-icon name="calendar-outline"></ion-icon>
                          <span class="date-text">Créée: {{ formatReservationDate(reservation.created_at) }}</span>
                        </div>
                        <div class="validation-info" *ngIf="reservation.date_code_validation">
                          <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                          <span class="validation-text">Validée: {{ formatReservationDate(reservation.date_code_validation) }}</span>
                        </div>
                        <div class="duration-info" *ngIf="reservation.date_code_validation">
                          <ion-icon name="time-outline" color="warning"></ion-icon>
                          <span class="duration-text">Durée: {{ calculateDurationSinceAcceptation(reservation.created_at, reservation.date_code_validation) }}</span>
                        </div>
                        <div class="scheduled-info" *ngIf="reservation.date_reservation">
                          <ion-icon name="calendar-number-outline" color="primary"></ion-icon>
                          <span class="scheduled-text">Planifiée: {{ formatScheduledDate(reservation.date_reservation, reservation.heure_reservation, reservation.minute_reservation) }}</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Départ avec icône et adresse cliquable -->
                    <div class="location-row">
                      <ion-icon name="location" class="location-icon departure-icon"></ion-icon>
                      <div class="location-content">
                        <div class="location-label">Départ</div>
                        <div class="location-address clickable-location" (click)="openPositionInMaps(reservation.position_depart)">
                          {{ reservation.depart_nom || 'Position non spécifiée' }}
                          <ion-icon name="navigate-outline" class="navigate-icon"></ion-icon>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Destination avec icône et adresse cliquable -->
                    <div class="location-row">
                      <ion-icon name="flag" class="location-icon destination-icon"></ion-icon>
                      <div class="location-content">
                        <div class="location-label">Destination</div>
                        <div class="location-address clickable-location" (click)="openPositionInMaps(reservation.position_arrivee)">
                          {{ reservation.destination_nom || 'Destination non définie' }}
                          <ion-icon name="navigate-outline" class="navigate-icon"></ion-icon>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Footer avec infos client, distance et prix -->
                    <div class="reservation-footer-entreprise">
                      <div class="footer-left">
                        <ion-icon name="call" class="phone-icon"></ion-icon>
                        <span class="client-phone clickable-phone" (click)="callClient(reservation.client_phone, $event)">
                          {{ reservation.client_phone }}
                        </span>
                        <span class="distance-info" *ngIf="reservation.distance_km">
                          {{ reservation.distance_km }} km
                        </span>
                      </div>
                      <div class="footer-right">
                        <ion-icon name="cash" class="price-icon"></ion-icon>
                        <span class="price-text">{{ formatCurrency(reservation.prix_total) }}</span>
                      </div>
                    </div>
                    
                    <!-- Info validation si présente -->
                    <div class="validation-info" *ngIf="reservation.date_code_validation">
                      <ion-icon name="checkmark-circle" color="success"></ion-icon>
                      <span>cool trajet réalisé</span>
                    </div>
                  </div>
                  
                  <div *ngIf="getReservations(conducteur.id).length === 0" class="no-reservations">
                    Aucune réservation trouvée
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="modal-actions" *ngIf="!isLoadingConducteurs && conducteursList.length > 0">
          <ion-button expand="block" fill="outline" (click)="exportConducteursList()">
            <ion-icon name="download-outline" slot="start"></ion-icon>
            Exporter la liste
          </ion-button>
        </div>

      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal Ajout Conducteur - Copie exacte de la structure entreprise qui fonctionne -->
  <ion-modal [isOpen]="isAddConducteurModalOpen" (didDismiss)="closeAddConducteurModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Nouveau Conducteur</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddConducteurModal()">
              <ion-icon name="close-circle-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        
        <ion-item>
          <ion-label position="stacked">Nom *</ion-label>
          <ion-input
            [(ngModel)]="addConducteurForm.nom"
            placeholder="Nom du conducteur">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Prénom *</ion-label>
          <ion-input
            [(ngModel)]="addConducteurForm.prenom"
            placeholder="Prénom du conducteur">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Téléphone *</ion-label>
          <ion-input
            [(ngModel)]="addConducteurForm.telephone"
            type="tel"
            placeholder="622123456">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Type de véhicule *</ion-label>
          <ion-select
            [(ngModel)]="addConducteurForm.vehicle_type"
            placeholder="Sélectionner le type">
            <ion-select-option value="moto">Moto</ion-select-option>
            <ion-select-option value="voiture">Voiture</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Marque (optionnel)</ion-label>
          <ion-input
            [(ngModel)]="addConducteurForm.vehicle_marque"
            placeholder="Ex: Toyota, Honda">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Modèle (optionnel)</ion-label>
          <ion-input
            [(ngModel)]="addConducteurForm.vehicle_modele"
            placeholder="Ex: Corolla, CBR">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Plaque d'immatriculation (optionnel)</ion-label>
          <ion-input
            [(ngModel)]="addConducteurForm.vehicle_plaque"
            placeholder="Ex: RC-123-AB">
          </ion-input>
        </ion-item>

        <div class="modal-actions">
          <ion-button 
            expand="block" 
            (click)="onConducteurCreated()"
            [disabled]="isAddingConducteur">
            {{ isAddingConducteur ? 'Création en cours...' : 'Créer le conducteur' }}
          </ion-button>
          <ion-button 
            expand="block" 
            fill="outline" 
            (click)="closeAddConducteurModal()">
            Annuler
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal de détails de réservation (copié depuis entreprise/reservations) -->
  <ion-modal [isOpen]="isDetailsModalOpen" (didDismiss)="closeDetailsModal()" class="details-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar class="modal-toolbar">
          <ion-title>Détails de la réservation</ion-title>
          <ion-button slot="end" fill="clear" (click)="closeDetailsModal()">
            <ion-icon name="close" style="font-size: 1.5rem;"></ion-icon>
          </ion-button>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding" *ngIf="selectedReservationDetails">
        <div class="modal-content">
          <!-- En-tête avec statut -->
          <div class="modal-header">
            <h2 class="modal-title">{{ selectedReservationDetails.destination_nom || 'Destination non spécifiée' }}</h2>
            <ion-badge [color]="getStatusColor(selectedReservationDetails.statut)" class="modal-status">
              {{ getStatusText(selectedReservationDetails.statut) }}
            </ion-badge>
          </div>

          <!-- Informations du conducteur -->
          <div class="info-section">
            <h3 class="section-title">
              <ion-icon name="person"></ion-icon>
              Conducteur
            </h3>
            <div class="info-content">
              <p class="info-item">
                {{ selectedReservationDetails.conducteur?.prenom }} {{ selectedReservationDetails.conducteur?.nom }}
              </p>
              <p class="info-item" *ngIf="selectedReservationDetails.conducteur?.telephone">
                <strong>Téléphone:</strong> {{ selectedReservationDetails.conducteur?.telephone }}
              </p>
            </div>
          </div>

          <!-- Informations du client -->
          <div class="info-section">
            <h3 class="section-title">
              <ion-icon name="call"></ion-icon>
              Client
            </h3>
            <div class="info-content">
              <p class="info-item">
                <strong>Téléphone:</strong> {{ selectedReservationDetails.client_phone || 'N/A' }}
              </p>
            </div>
          </div>

          <!-- Localisation -->
          <div class="info-section">
            <h3 class="section-title">
              <ion-icon name="location"></ion-icon>
              Trajets
            </h3>
            <div class="info-content">
              <div class="location-block">
                <p class="location-type">Position de départ:</p>
                <div class="location-with-map" (click)="openPositionInMaps(selectedReservationDetails.position_depart)">
                  <p class="location-text">{{ selectedReservationDetails.depart_nom || 'Non spécifiée' }}</p>
                  <ion-icon name="map" class="map-link-icon"></ion-icon>
                </div>
              </div>
              <div class="location-block" *ngIf="selectedReservationDetails.destination_nom">
                <p class="location-type">Destination:</p>
                <div class="location-with-map" (click)="openPositionInMaps(selectedReservationDetails.position_arrivee)">
                  <p class="location-text">{{ selectedReservationDetails.destination_nom }}</p>
                  <ion-icon name="map" class="map-link-icon"></ion-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- Détails de la course -->
          <div class="info-section">
            <h3 class="section-title">
              <ion-icon name="car"></ion-icon>
              Détails de la course
            </h3>
            <div class="info-content">
              <div class="detail-grid">
                <div class="detail-card">
                  <ion-icon name="speedometer" class="detail-card-icon"></ion-icon>
                  <div class="detail-card-content">
                    <p class="detail-label">Distance</p>
                    <p class="detail-value">{{ formatDistance(selectedReservationDetails.distance_km) }}</p>
                  </div>
                </div>
                <div class="detail-card">
                  <ion-icon name="cash" class="detail-card-icon"></ion-icon>
                  <div class="detail-card-content">
                    <p class="detail-label">Prix total</p>
                    <p class="detail-value">{{ formatCurrency(selectedReservationDetails.prix_total) }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Dates -->
          <div class="info-section">
            <h3 class="section-title">
              <ion-icon name="calendar"></ion-icon>
              Dates
            </h3>
            <div class="info-content">
              <p class="info-item">
                <strong>Créée le:</strong> {{ formatDate(selectedReservationDetails.created_at) }}
              </p>
              <p class="info-item" *ngIf="selectedReservationDetails.date_code_validation">
                <strong>Validée le:</strong> {{ formatDate(selectedReservationDetails.date_code_validation) }}
              </p>
            </div>
          </div>

          <!-- Commentaire et notation -->
          <div class="info-section" *ngIf="selectedReservationDetails.commentaire || selectedReservationDetails.note_conducteur">
            <h3 class="section-title">
              <ion-icon name="chatbubble-ellipses"></ion-icon>
              Évaluation
            </h3>
            <div class="info-content">
              <div class="rating-section" *ngIf="selectedReservationDetails.note_conducteur">
                <p class="info-item"><strong>Note:</strong></p>
                <div class="stars">
                  <ion-icon name="star" *ngFor="let star of getRatingStars(selectedReservationDetails.note_conducteur)" class="star-filled"></ion-icon>
                  <span class="rating-value">({{ selectedReservationDetails.note_conducteur }}/5)</span>
                </div>
              </div>
              <div class="comment-section" *ngIf="selectedReservationDetails.commentaire">
                <p class="info-item"><strong>Commentaire:</strong></p>
                <div class="comment-box">
                  {{ selectedReservationDetails.commentaire }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal Configuration LengoPay -->
  <ion-modal [isOpen]="isLengoPayConfigModalOpen" (didDismiss)="closeLengoPayConfigModal()" class="lengopay-config-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar class="lengopay-config-toolbar">
          <ion-button 
            slot="start" 
            fill="clear" 
            (click)="closeLengoPayConfigModal()"
            color="light">
            <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-title>
            <ion-icon name="card-outline"></ion-icon>
            Configuration Paiement - {{ selectedEntrepriseForLengoPay?.nom }}
            <ion-chip 
              *ngIf="isCreationMode" 
              color="success" 
              class="mode-indicator">
              <ion-icon name="add-circle-outline"></ion-icon>
              <ion-label>Mode Création</ion-label>
            </ion-chip>
            <ion-chip 
              *ngIf="!isCreationMode" 
              color="warning" 
              class="mode-indicator">
              <ion-icon name="create-outline"></ion-icon>
              <ion-label>Mode Édition</ion-label>
            </ion-chip>
          </ion-title>
          <ion-button 
            slot="end" 
            fill="clear" 
            (click)="refreshLengoPayConfig()"
            color="light">
            <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        
        <!-- Loading -->
        <div *ngIf="isLoadingLengoPayConfig" class="loading-container">
          <ion-spinner></ion-spinner>
          <p>Chargement de la configuration...</p>
        </div>

        <!-- Configuration existante -->
        <div *ngIf="!isLoadingLengoPayConfig">
          
          <!-- En-tête Entreprise -->
          <ion-card class="enterprise-card" *ngIf="selectedEntrepriseForLengoPay">
            <ion-card-content>
              <div class="enterprise-header">
                <div class="enterprise-avatar">
                  {{ getEnterpriseInitials(selectedEntrepriseForLengoPay) }}
                </div>
                <div class="enterprise-info">
                  <h2>{{ selectedEntrepriseForLengoPay.nom }}</h2>
                  <p class="proprietaire-label">Propriétaire</p>
                </div>
                <div class="enterprise-status">
                  <ion-badge [color]="selectedEntrepriseForLengoPay.actif ? 'success' : 'danger'" class="status-badge">
                    {{ selectedEntrepriseForLengoPay.actif ? 'ACTIF' : 'INACTIF' }}
                  </ion-badge>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Section Configuration LengoPay -->
          <div class="lengopay-section">
            <div class="lengopay-header">
              <div class="lengopay-logo">
                <img src="https://portal.lengopay.com/public/images/logo_lengopay_black.png" 
                     alt="LengoPay" 
                     class="lengopay-logo-img">
              </div>
              <div class="lengopay-title">Configuration LengoPay</div>
              <div class="lengopay-status">
                <ion-badge [color]="isLengoPayActive ? 'success' : 'medium'" class="config-status">
                  {{ isLengoPayActive ? 'ACTIF' : 'INACTIF' }}
                </ion-badge>
                <ion-button 
                  size="small" 
                  fill="clear" 
                  [color]="isLengoPayActive ? 'danger' : 'success'"
                  (click)="toggleLengoPayActive()"
                  class="toggle-status-btn">
                  <ion-icon [name]="isLengoPayActive ? 'close-circle-outline' : 'checkmark-circle-outline'" slot="icon-only"></ion-icon>
                  {{ isLengoPayActive ? 'Désactiver' : 'Activer' }}
                </ion-button>
              </div>
            </div>

            <!-- Formulaire de configuration -->
            <div class="config-form">
              
              <!-- URL API -->
              <div class="config-field">
                <div class="field-header">
                  <ion-icon name="globe-outline"></ion-icon>
                  <span class="field-label">URL API</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [(ngModel)]="lengoPayForm.api_url"
                    [readonly]="!isEditingLengoPay"
                    placeholder="https://sandbox.lengopay.com/api/v1/payments"
                    class="lengopay-input">
                  </ion-input>
                  <div class="field-actions">
                    <ion-button 
                      *ngIf="!isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="editLengoPayField('api_url')"
                      color="primary">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-button 
                      *ngIf="isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="saveLengoPayField('api_url')"
                      color="success">
                      <ion-icon name="checkmark-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>

              <!-- CLÉ DE LICENCE -->
              <div class="config-field">
                <div class="field-header">
                  <ion-icon name="key-outline"></ion-icon>
                  <span class="field-label">CLÉ DE LICENCE</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [(ngModel)]="lengoPayForm.license_key"
                    [readonly]="!isEditingLengoPay"
                    [type]="showLicenseKey ? 'text' : 'password'"
                    [placeholder]="isCreationMode ? 'Saisissez votre clé de licence LengoPay' : 'VmVHNGZud2h1YVdUUnBSYnZ1R3BlNmtMTFhHN1NDNGpaU3plMENtQ1drZ084Y280S2J5ODZPWXJQVWZRT05OWg=='"
                    class="lengopay-input">
                  </ion-input>
                  <div class="field-actions">
                    <ion-button 
                      size="small" 
                      fill="clear" 
                      (click)="toggleLicenseKeyVisibility()"
                      color="medium">
                      <ion-icon [name]="showLicenseKey ? 'eye-off-outline' : 'eye-outline'" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-button 
                      *ngIf="!isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="editLengoPayField('license_key')"
                      color="primary">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-button 
                      *ngIf="isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="saveLengoPayField('license_key')"
                      color="success">
                      <ion-icon name="checkmark-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>

              <!-- WEBSITE ID -->
              <div class="config-field">
                <div class="field-header">
                  <ion-icon name="id-card-outline"></ion-icon>
                  <span class="field-label">WEBSITE ID</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [(ngModel)]="lengoPayForm.website_id"
                    [readonly]="!isEditingLengoPay"
                    [placeholder]="isCreationMode ? 'Votre Website ID (ex: wyp6J7uN3pVG2Pjn)' : 'wyp6J7uN3pVG2Pjn'"
                    class="lengopay-input">
                  </ion-input>
                  <div class="field-actions">
                    <ion-button 
                      *ngIf="!isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="editLengoPayField('website_id')"
                      color="primary">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-button 
                      *ngIf="isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="saveLengoPayField('website_id')"
                      color="success">
                      <ion-icon name="checkmark-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>

              <!-- URL DE CALLBACK -->
              <div class="config-field">
                <div class="field-header">
                  <ion-icon name="return-up-back-outline"></ion-icon>
                  <span class="field-label">URL DE CALLBACK</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [(ngModel)]="lengoPayForm.callback_url"
                    [readonly]="!isEditingLengoPay"
                    [placeholder]="isCreationMode ? 'URL de callback (optionnel)' : 'https://api.whatsapp.com/send/?phone=22462354219'"
                    class="lengopay-input">
                  </ion-input>
                  <div class="field-actions">
                    <ion-button 
                      *ngIf="!isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="editLengoPayField('callback_url')"
                      color="primary">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-button 
                      *ngIf="isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="saveLengoPayField('callback_url')"
                      color="success">
                      <ion-icon name="checkmark-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>

              <!-- TÉLÉPHONE MARCHAND -->
              <div class="config-field">
                <div class="field-header">
                  <ion-icon name="call-outline"></ion-icon>
                  <span class="field-label">TÉLÉPHONE MARCHAND</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [(ngModel)]="lengoPayForm.telephone_marchand"
                    [readonly]="!isEditingLengoPay"
                    [placeholder]="isCreationMode ? 'Numéro de téléphone marchand' : '628406028'"
                    class="lengopay-input">
                  </ion-input>
                  <div class="field-actions">
                    <ion-button 
                      *ngIf="!isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="editLengoPayField('telephone_marchand')"
                      color="primary">
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-button 
                      *ngIf="isEditingLengoPay" 
                      size="small" 
                      fill="clear" 
                      (click)="saveLengoPayField('telephone_marchand')"
                      color="success">
                      <ion-icon name="checkmark-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>

            </div>

            <!-- Actions principales -->
            <div class="lengopay-actions">
              
              <!-- MODE CRÉATION : Bouton créer -->
              <ion-button 
                *ngIf="isCreationMode"
                expand="block" 
                color="primary"
                (click)="createLengoPayConfiguration()"
                [disabled]="!isLengoPayFormValid() || isTesting">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                {{ isTesting ? 'Création en cours...' : 'Créer la configuration' }}
              </ion-button>

              <!-- MODE CONSULTATION : Boutons test et désactivation -->
              <ion-button 
                *ngIf="!isCreationMode"
                expand="block" 
                color="secondary"
                (click)="testLengoPayConfiguration()"
                [disabled]="isTesting">
                <ion-icon name="flash-outline" slot="start"></ion-icon>
                {{ isTesting ? 'Test en cours...' : 'Tester la configuration' }}
              </ion-button>
              
              <ion-button 
                *ngIf="!isCreationMode"
                expand="block" 
                fill="outline"
                color="warning"
                (click)="deactivateLengoPayConfig()"
                [disabled]="!lengoPayConfig?.is_active">
                <ion-icon name="pause-outline" slot="start"></ion-icon>
                Désactiver
              </ion-button>

            </div>

          </div>

          <!-- Section Configuration Green API (Préremplie et non modifiable) -->
          <div class="greenapi-section" [class.disabled-section]="!isCreationMode">
            <div class="section-header" [class.disabled-header]="!isCreationMode">
              <ion-icon name="chatbubble-ellipses-outline" [class.disabled-icon]="!isCreationMode"></ion-icon>
              <span class="section-title" [class.disabled-title]="!isCreationMode">Configuration Green API</span>
              <div class="enabled-badge" *ngIf="isCreationMode">
                <span>WHATSAPP BUSINESS (INCLUS)</span>
              </div>
              <div class="disabled-badge" *ngIf="!isCreationMode">
                <span>WHATSAPP BUSINESS (DÉSACTIVÉ)</span>
              </div>
            </div>

            <!-- Formulaire Green API -->
            <div class="config-form" [class.disabled-form]="!isCreationMode">
              
              <!-- INSTANCE ID -->
              <div class="config-field" [class.disabled-field]="!isCreationMode">
                <div class="field-header" [class.disabled-header]="!isCreationMode">
                  <ion-icon name="id-card-outline" [class.disabled-icon]="!isCreationMode"></ion-icon>
                  <span class="field-label" [class.disabled-label]="!isCreationMode">INSTANCE ID</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [value]="greenApiData.instance_id"
                    readonly
                    class="lengopay-input" 
                    [class.disabled-input]="!isCreationMode">
                  </ion-input>
                </div>
              </div>

              <!-- TOKEN API -->
              <div class="config-field" [class.disabled-field]="!isCreationMode">
                <div class="field-header" [class.disabled-header]="!isCreationMode">
                  <ion-icon name="key-outline" [class.disabled-icon]="!isCreationMode"></ion-icon>
                  <span class="field-label" [class.disabled-label]="!isCreationMode">TOKEN API</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [value]="greenApiData.token"
                    readonly
                    type="password"
                    class="lengopay-input"
                    [class.disabled-input]="!isCreationMode">
                  </ion-input>
                </div>
              </div>

              <!-- BASE URL -->
              <div class="config-field" [class.disabled-field]="!isCreationMode">
                <div class="field-header" [class.disabled-header]="!isCreationMode">
                  <ion-icon name="globe-outline" [class.disabled-icon]="!isCreationMode"></ion-icon>
                  <span class="field-label" [class.disabled-label]="!isCreationMode">BASE URL</span>
                </div>
                <div class="field-content">
                  <ion-input
                    [value]="greenApiData.base_url"
                    readonly
                    class="lengopay-input"
                    [class.disabled-input]="!isCreationMode">
                  </ion-input>
                </div>
              </div>

            </div>
          </div>

        </div>

      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>